{"version":3,"sources":["../../../../assets/scripts/assets/scripts/networkMgr.js"],"names":["cc","Class","extends","Component","properties","ipconfig","default","type","JsonAsset","requestType","retryLayerPrefab","Prefab","ws","onLoad","game","addPersistRootNode","node","ip","json","port","url","WebSocket","self","onerror","event","addRetryLayerToScene","onopen","loginSys","require","login","onmessage","content","data","messageObj","JSON","parse","loadingSceneMgr","find","getComponent","onReceiveMessage","changeToScene","gameMgr","currentDollor","onclose","start","update","sendMessageToServer","message","readyState","send","canvas","retryLayer","instantiate","setPosition","addChild","button","getChildByName","on","retryConnect","director","pause","resume","removePersistRootNode","loadScene"],"mappings":"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","file":"networkMgr.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        \n        ipconfig: {\n            default: null,\n            type: cc.JsonAsset\n        },\n        requestType: {\n            default: null,\n            type: cc.JsonAsset\n        },\n        retryLayerPrefab: {\n            default: null,\n            type: cc.Prefab\n        },\n        ws: null\n    },\n\n\n    onLoad () {\n        cc.game.addPersistRootNode(this.node);\n        var ip = this.ipconfig.json.ip;\n        var port = this.ipconfig.json.port;\n        var url = \"ws://\" + ip + \":\" + port;\n        this.ws = new WebSocket(url);\n\n        var self = this;\n        this.ws.onerror = function(event) {\n            self.addRetryLayerToScene();\n        }\n        this.ws.onopen = function(event) {\n            var loginSys = require(\"loginSys\");\n            loginSys.login();\n        }\n        this.ws.onmessage = function(event) {\n            var content = event.data;\n\n            var messageObj = JSON.parse(content);\n            \n            if (messageObj.type == \"login\") {\n                var data = JSON.parse(messageObj.data);\n                var loginSys = require(\"loginSys\");\n                var loadingSceneMgr = cc.find(\"Canvas\").getComponent(\"loadingSceneMgr\");\n                loginSys.onReceiveMessage(data,loadingSceneMgr.changeToScene,loadingSceneMgr);\n            }\n            else if (messageObj.type == \"catchFish\") {\n                var gameMgr = cc.find(\"Canvas\").getComponent(\"gameMgr\");\n                var data = messageObj.currentDollor;\n                gameMgr.onReceiveMessage(data,messageObj.type);\n            }\n            else if (messageObj.type == \"changeArea\") {\n                var gameMgr = cc.find(\"Canvas\").getComponent(\"gameMgr\");\n                var data = JSON.parse(messageObj.data);\n                gameMgr.onReceiveMessage(data,messageObj.type);\n            }\n        }\n        this.ws.onclose = function(event) {\n            self.addRetryLayerToScene();\n        }\n    },\n\n    start () {\n\n    },\n    update(){\n\n    },\n    sendMessageToServer(message) {\n        if (this.ws.readyState == 1) {\n            this.ws.send(message);\n        }\n    },\n\n    addRetryLayerToScene(){\n        var canvas = cc.find(\"Canvas\");\n        var retryLayer = cc.instantiate(this.retryLayerPrefab);\n        retryLayer.setPosition(0,0);\n        canvas.addChild(retryLayer);\n        var button = retryLayer.getChildByName(\"button\")\n        button.on(\"click\",this.retryConnect,this);\n        cc.director.pause();\n        \n    },\n    retryConnect() {\n        cc.director.resume();\n        var node = cc.find(\"networkMgrNode\");\n        cc.game.removePersistRootNode(node);\n        cc.director.loadScene(\"loadingScene\");\n    }\n\n\n});\n\n"]}